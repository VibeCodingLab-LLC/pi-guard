# =============================================================================
# Pi Guard - Enhanced Audit Rules
# /etc/audit/rules.d/pi-guard.rules
#
# Monitors:
#   - Authentication events
#   - Critical file changes
#   - Pi Guard service configs
#   - Network configuration
#   - Privilege escalation
#   - Command execution
# =============================================================================

# Delete all existing rules
-D

# Buffer size (tuned for Pi - reduce if RAM issues)
-b 1024

# Failure mode (1 = printk, 2 = panic)
-f 1

# =============================================================================
# AUTHENTICATION & AUTHORIZATION
# =============================================================================

# Login/logout events
-w /var/log/faillog -p wa -k auth
-w /var/log/lastlog -p wa -k auth
-w /var/run/faillock -p wa -k auth
-w /var/log/btmp -p wa -k auth
-w /var/log/wtmp -p wa -k auth

# Password and group changes
-w /etc/passwd -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# Sudoers
-w /etc/sudoers -p wa -k sudo_changes
-w /etc/sudoers.d -p wa -k sudo_changes

# =============================================================================
# SSH MONITORING
# =============================================================================

-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/ssh/ssh_config -p wa -k ssh_config
-w /root/.ssh -p wa -k ssh_keys
-w /home/pi/.ssh -p wa -k ssh_keys

# =============================================================================
# PI GUARD SERVICES (Critical - watch these closely)
# =============================================================================

# Pi-hole configuration
-w /etc/pihole -p wa -k pihole_config
-w /etc/pihole/setupVars.conf -p wa -k pihole_config
-w /etc/pihole/pihole-FTL.conf -p wa -k pihole_config

# Unbound (DNS)
-w /etc/unbound -p wa -k unbound_config
-w /var/lib/unbound -p wa -k unbound_config

# fail2ban
-w /etc/fail2ban -p wa -k fail2ban_config
-w /etc/fail2ban/jail.local -p wa -k fail2ban_config

# Snort IDS
-w /etc/snort -p wa -k snort_config
-w /etc/snort/snort.lua -p wa -k snort_config
-w /var/log/snort -p wa -k snort_logs

# iptables firewall
-w /etc/iptables -p wa -k firewall_config
-w /usr/local/bin/pi-guard-firewall.sh -p wa -k firewall_config

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

-w /etc/hosts -p wa -k network_config
-w /etc/hostname -p wa -k network_config
-w /etc/resolv.conf -p wa -k network_config
-w /etc/network -p wa -k network_config
-w /etc/NetworkManager -p wa -k network_config

# =============================================================================
# SCHEDULED TASKS (Persistence mechanism)
# =============================================================================

-w /etc/crontab -p wa -k cron_changes
-w /etc/cron.d -p wa -k cron_changes
-w /etc/cron.daily -p wa -k cron_changes
-w /etc/cron.hourly -p wa -k cron_changes
-w /etc/cron.weekly -p wa -k cron_changes
-w /etc/cron.monthly -p wa -k cron_changes
-w /var/spool/cron -p wa -k cron_changes

# =============================================================================
# SYSTEM STARTUP (Persistence mechanism)
# =============================================================================

-w /etc/init.d -p wa -k init_changes
-w /etc/systemd/system -p wa -k systemd_changes
-w /lib/systemd/system -p wa -k systemd_changes
-w /etc/rc.local -p wa -k init_changes

# =============================================================================
# PRIVILEGED COMMAND EXECUTION
# =============================================================================

# Track execve calls for key commands
-a always,exit -F arch=b32 -S execve -F path=/usr/bin/passwd -k exec_passwd
-a always,exit -F arch=b32 -S execve -F path=/usr/bin/sudo -k exec_sudo
-a always,exit -F arch=b32 -S execve -F path=/usr/bin/su -k exec_su
-a always,exit -F arch=b32 -S execve -F path=/usr/sbin/iptables -k exec_iptables
-a always,exit -F arch=b32 -S execve -F path=/usr/sbin/usermod -k exec_usermod
-a always,exit -F arch=b32 -S execve -F path=/usr/sbin/useradd -k exec_useradd
-a always,exit -F arch=b32 -S execve -F path=/usr/sbin/userdel -k exec_userdel

# 64-bit versions (for Pi 3A+ with 64-bit OS)
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/passwd -k exec_passwd
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/sudo -k exec_sudo
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/su -k exec_su
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/iptables -k exec_iptables

# =============================================================================
# SUSPICIOUS ACTIVITY
# =============================================================================

# Module loading/unloading
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules

# Watch for attempts to alter time (anti-forensics)
-a always,exit -F arch=b32 -S adjtimex,settimeofday,stime -k time_change
-a always,exit -F arch=b64 -S adjtimex,settimeofday -k time_change

# =============================================================================
# MAKE RULES IMMUTABLE (uncomment for production)
# Requires reboot to change rules after this
# =============================================================================
# -e 2
